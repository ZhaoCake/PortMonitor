@startuml PortMonitor_Sequence_Diagram

' 样式设置
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 100
skinparam sequenceParticipant underline
skinparam BackgroundColor white
skinparam FontName "Microsoft YaHei"

' 定义参与者
actor User as "用户"
participant UI as "Ui_Serial_MainWindow\n(界面)"
participant App as "SerialAppClass\n(应用逻辑)"
participant Config as "JSONConfigManager\n(配置)"
participant Serial as "SerialProcess\n(串口处理)"
participant Port as "QSerialPort\n(底层串口)"

== 应用程序初始化 ==

User -> App: 启动应用
activate App

App -> UI: setupUi()
activate UI
UI --> App: 创建所有UI控件
deactivate UI

App -> Config: load_or_create_config()
activate Config
Config -> Config: 读取 config.json
Config --> App: 返回配置
deactivate Config

App -> Serial: 创建 SerialProcess 实例
activate Serial
Serial -> Port: 创建 QSerialPort
Serial --> App: 
deactivate Serial

App -> App: connect_signals()
note right
  连接所有信号与槽：
  • UI 按钮 → App 方法
  • Serial 信号 → App 回调
  • 定时器 → 刷新函数
end note

App -> App: refresh_ports()
App -> App: load_last_settings()

App -> UI: 更新界面显示
deactivate App

== 打开串口流程 ==

User -> UI: 点击"打开串口"按钮
activate UI
UI -> App: open_btn.clicked 信号
deactivate UI

activate App
App -> App: toggle_serial_port()
App -> App: open_serial_port()

App -> App: 获取串口参数
note right
  从UI控件读取：
  • 端口名
  • 波特率
  • 数据位
  • 校验位
  • 停止位
  • 流控制
end note

App -> Serial: open_port(port_name, ...)
activate Serial

Serial -> Port: setPortName()
Serial -> Port: setBaudRate()
Serial -> Port: setDataBits()
Serial -> Port: setParity()
Serial -> Port: setStopBits()
Serial -> Port: setFlowControl()

Serial -> Port: open(ReadWrite)
activate Port

alt 打开成功
    Port --> Serial: True
    Serial -> Serial: is_open = True
    Serial -[#00AA00]-> App: port_opened 信号
    deactivate Serial
    
    App -> UI: 更新按钮文本为"关闭串口"
    App -> UI: statusbar显示"串口已打开"
    activate UI
    UI --> User: 显示成功提示
    deactivate UI
    
else 打开失败
    Port --> Serial: False
    Serial -[#FF0000]-> App: error_occurred 信号
    deactivate Serial
    
    App -> UI: 弹出错误对话框
    activate UI
    UI --> User: 显示错误信息
    deactivate UI
end

deactivate Port
deactivate App

== 接收数据流程 ==

Port -> Serial: readyRead 信号
activate Serial
note right of Serial
  串口有数据到达
end note

Serial -> Serial: read_data()
Serial -> Port: readAll()
activate Port
Port --> Serial: QByteArray(数据)
deactivate Port

Serial -> Serial: receive_count += 数据大小
Serial -[#0066FF]-> App: data_received 信号(data)
deactivate Serial

activate App
App -> App: on_data_received(data)

alt 判断是否是电机数据
    App -> App: 检查是否以"[M]:"开头
    App -> App: motor_data_process()
    App -> App: update_speed_chart()
else 普通串口数据
    alt 十六进制显示模式
        App -> App: data.toHex().toUpper()
        App -> App: 格式化为两位一组
    else 文本显示模式
        App -> App: data.decode('utf-8')
    end
    
    alt 启用时间戳
        App -> App: 添加时间戳前缀
    end
    
    App -> App: append_to_receive(text)
    App -> UI: receive_tEdit 插入文本
    activate UI
    UI --> User: 显示接收到的数据
    deactivate UI
end

deactivate App

== 发送数据流程 ==

User -> UI: 在发送框输入数据
activate UI
User -> UI: 点击"发送"按钮
UI -> App: self_send_btn.clicked 信号
deactivate UI

activate App
App -> App: send_data()

alt 检查串口是否打开
    App -> App: 检查 serial_process.is_open
    
    alt 串口未打开
        App -> UI: 显示错误提示
        activate UI
        UI --> User: "串口未打开"
        deactivate UI
        deactivate App
    else 串口已打开
        alt 十六进制发送模式
            App -> App: 获取 actual_hex_text
            App -> App: 移除空格和换行
            App -> App: 转换为 bytes.fromhex()
        else 文本发送模式
            App -> App: 获取 actual_text
            App -> App: encode('utf-8')
        end
        
        App -> Serial: send_data(data, data_hex, is_hex)
        activate Serial
        
        Serial -> Port: write(byte_data)
        activate Port
        Port --> Serial: bytes_written
        deactivate Port
        
        alt 发送成功
            Serial -> Serial: send_count += bytes_written
            Serial -> Port: flush()
            Serial --> App: True
            deactivate Serial
            
            App -> UI: 更新发送统计
        else 发送失败
            Serial -[#FF0000]-> App: error_occurred 信号
            deactivate Serial
            
            App -> UI: 显示错误
        end
    end
end

deactivate App

== 自动发送流程 ==

User -> UI: 点击"启动自动发送"
activate UI
UI -> App: auto_send_btn.clicked 信号
deactivate UI

activate App
App -> App: on_auto_send_changed()
App -> App: 读取发送间隔
App -> App: auto_send_timer.start(interval)

loop 每隔指定时间
    App -> App: auto_send_function()
    App -> App: send_data()
    note right: 复用发送数据流程
end

User -> UI: 点击"停止自动发送"
activate UI
UI -> App: auto_send_btn.clicked 信号
deactivate UI

App -> App: auto_send_timer.stop()
deactivate App

== 保存配置流程 ==

User -> UI: 修改任意设置\n(端口/波特率/复选框等)
activate UI
UI -> App: 控件信号 (textChanged/stateChanged)
deactivate UI

activate App
App -> App: auto_save_settings()
App -> App: save_current_settings()

App -> Config: save_all_settings(self)
activate Config

Config -> Config: 收集所有设置到 dict
note right
  保存的设置包括：
  • 串口参数
  • 发送/接收选项
  • 流控制状态
  • 文件路径
end note

Config -> Config: save_config()
Config -> Config: 写入 config.json

Config --> App: 保存完成
deactivate Config
deactivate App

== 关闭串口流程 ==

User -> UI: 点击"关闭串口"按钮
activate UI
UI -> App: open_btn.clicked 信号
deactivate UI

activate App
App -> App: toggle_serial_port()

App -> Serial: close_port()
activate Serial

Serial -> Port: close()
activate Port
Port --> Serial: 
deactivate Port

Serial -> Serial: is_open = False
Serial -[#FFA500]-> App: port_closed 信号
deactivate Serial

App -> UI: 更新按钮文本为"打开串口"
App -> UI: statusbar显示"串口已关闭"
activate UI
UI --> User: 显示关闭提示
deactivate UI

deactivate App

== 应用程序关闭 ==

User -> UI: 关闭窗口
activate UI
UI -> App: closeEvent()
deactivate UI

activate App
App -> App: save_current_settings()
note right: 最后一次保存配置

App -> Serial: close_port()
activate Serial
Serial -> Port: close()
Serial --> App: 
deactivate Serial

App -> Config: 保存配置
activate Config
Config --> App: 
deactivate Config

App --> UI: 允许关闭
deactivate App

@enduml
